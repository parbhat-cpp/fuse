events {}

http {
    log_format upstream_time '$remote_addr - $remote_user [$time_local] '
                             '"$request" $status $body_bytes_sent '
                             '"$http_referer" "$http_user_agent"'
                             'rt="$request_time" uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"';

    server {
        error_log /etc/nginx/logs/error.log warn;
        access_log /etc/nginx/logs/access.log upstream_time;
        listen 80;

        location /api/ {
            auth_request /auth;

            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $user_email $upstream_http_x_user_email;
            auth_request_set $user_name $upstream_http_x_user_name;

            proxy_set_header X-User-Id $user_id;
            proxy_set_header X-User-Email $user_email;
            proxy_set_header X-User-Name $user_name;

            proxy_pass http://main-backend:3000/;
        }

        location /subscription/ {
            auth_request /auth;

            auth_request_set $user_id $upstream_http_x_user_id;
            auth_request_set $user_email $upstream_http_x_user_email;
            auth_request_set $user_name $upstream_http_x_user_name;

            proxy_set_header X-User-Id $user_id;
            proxy_set_header X-User-Email $user_email;
            proxy_set_header X-User-Name $user_name;

            proxy_pass http://subscriptions:8080/;
        }

        location = /auth {
            internal;
            proxy_set_header Authorization $http_authorization;
            proxy_pass http://auth:5000/validate_token/;
        }
    }
}
